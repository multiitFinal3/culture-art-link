<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
>
  <html layout:decorate="~{common/layout/layoutMenubar}">
    <html lang="ko">
      <head>
        <style>
          body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
          }
          .tab-menu {
            margin-bottom: 20px;
          }
          .tab-menu button {
            padding: 10px 20px;
            margin-right: 5px;
          }
          .search-bar {
            background-color: #f0f0f0;
            padding: 20px;
            margin-bottom: 20px;
          }
          .search-bar select,
          .search-bar input {
            margin-right: 10px;
            padding: 5px;
          }
          .search-bar button {
            padding: 5px 10px;
          }
          .exhibition-list {
            list-style-type: none;
            padding: 0;
          }
          .exhibition-item {
            display: flex;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            padding: 10px;
          }
          .exhibition-image {
            width: 100px;
            height: 150px;
            object-fit: cover;
            margin-right: 20px;
          }
          .exhibition-info {
            flex-grow: 1;
          }
          .exhibition-actions {
            display: flex;
            align-items: start;
          }
          .action-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            margin-left: 10px;
          }
          .exhibition-content {
            display: flex;
            flex-grow: 1;
            cursor: pointer;
          }

          .exhibition-content:hover {
            background-color: #f0f0f0;
          }

          .background-pink {
            background-color: pink;
          }

          .background-gray {
            background-color: gray;
          }
        </style>
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script>
          let exhibitions = [];
          let viewStatus = "all"; // pre, current, future, unknown 어떤 버튼 눌렀는지
          let searchParams = { title: "", artist: "", museum: "" };

          $(document).ready(function () {
            init();

            // 전시 여부 버튼
            $("#currentBtn").click(function () {
              changeViewStatus("current");
            });
            $("#pastBtn").click(function () {
              changeViewStatus("past");
            });
            $("#futureBtn").click(function () {
              changeViewStatus("future");
            });
            $("#unknownBtn").click(function () {
              changeViewStatus("unknown");
            });
          });

          // 검색 버튼
          $(document).on('click', "#searchButton", function () {
            searchExhibitions();
          });



          function changeViewStatus(status) {
            viewStatus = status;
            filterAndRenderExhibitions();
          }

          async function getExhibitions() {
            const response = await axios.get(
              "/exhibition/exhibition"
            );

            exhibitions = response.data.map((item) => ({
              id: item.id,
              image: item.image,
              title: item.title,
              artist: item.artist,
              museum: item.museum,
              startDate: item.startDate ? new Date(item.startDate) : null,
              endDate: item.endDate ? new Date(item.endDate) : null,
              state: item.state
            }));

            filterAndRenderExhibitions();
          }

          function filterAndRenderExhibitions() {
            const today = new Date();
            const filteredExhibitions = exhibitions.filter((item) => {
              if (!matchesSearch(item)) return false;

              if (viewStatus === "all") return true;
              if (!item.startDate || !item.endDate)
                return viewStatus === "unknown";

              switch (viewStatus) {
                case "current":
                  return item.startDate <= today && today <= item.endDate;
                case "past":
                  return item.endDate < today;
                case "future":
                  return today < item.startDate;
                default:
                  return false;
              }
            });

            renderExhibitions(filteredExhibitions);
          }

          function matchesSearch(exhibition) {
            return (
                    exhibition.title.toLowerCase().includes(searchParams.title.toLowerCase()) &&
                    exhibition.artist.toLowerCase().includes(searchParams.artist.toLowerCase()) &&
                    exhibition.museum.toLowerCase().includes(searchParams.museum.toLowerCase())
            );
          }

          function searchExhibitions() {
            searchParams = {
              title: $("#searchTitle").val(),
              artist: $("#searchArtist").val(),
              museum: $("#searchMuseum").val(),
            };
            filterAndRenderExhibitions();
          }







          // 전시회 목록을 렌더링하는 함수
          function renderExhibitions(exhibitionsToRender) {
            const $exhibitionList = $(".exhibition-list");
            $exhibitionList.empty();

            $.each(exhibitionsToRender, function (index, exhibition) {
              const $li = $("<li>").addClass("exhibition-item");
              if(exhibition.state === "interested") {
                $li.addClass("background-pink")
              }else if(exhibition.state === "not_interested"){
                $li.addClass("background-gray")
              }


              $li.html(`
                <div class="exhibition-content" data-id="${exhibition.id}">
                  <img src="${exhibition.image}" alt="${exhibition.title}" class="exhibition-image">
                  <div class="exhibition-info">
                    <h3>${exhibition.title}</h3>
                    <p>${exhibition.artist}</p>
                    <p>${exhibition.museum}</p>
                    <p>시작일: ${exhibition.startDate ? exhibition.startDate.toISOString().split("T")[0] : "미정"}</p>
                    <p>종료일: ${exhibition.endDate ? exhibition.endDate.toISOString().split("T")[0] : "미정"}</p>
                  </div>
                </div>
                <div class="exhibition-actions">
                  <button class="exhibition-like" data-id="${exhibition.id}">찜</button>
                  <button class="exhibition-dislike" data-id="${exhibition.id}">관심없음</button>
                </div>
              `);
              $exhibitionList.append($li);
            });

            // 클릭하면 상세페이지로 들어감
            $(".exhibition-content").click(function() {
              const exhibitionId = $(this).data("id");
              window.location.href = `/exhibition/detail/${exhibitionId}`;
            });

            // 찜 버튼 클릭 이벤트
            $(".exhibition-like").click(function(e) {
              e.stopPropagation();
              const exhibitionId = $(this).data("id");
              console.log("exhibition-like btn : ",exhibitionId)
              updateInterest(exhibitionId, 'interested');
            });

            // 관심없음 버튼 클릭 이벤트
            $(".exhibition-dislike").click(function(e) {
              e.stopPropagation();
              const exhibitionId = $(this).data("id");
              console.log("exhibition-dislike btn : ",exhibitionId)
              updateInterest(exhibitionId, 'not_interested');
            });
          }

          function updateInterest(exhibitionId, state) {
            axios.post('/exhibition/interested', {
              exhibitionId: Number(exhibitionId),
              state: state
            })
            .then(function (response) {
              console.log('Interest updated successfully');
              // 여기에 UI 업데이트 로직을 추가할 수 있습니다.
            })
            .catch(function (error) {
              console.error('Error updating interest:', error);
            });
          }




          //페이지에 들어갔을 때 실행 되는 init 함수
          function init() {
            getExhibitions();
          }

          // // 전시회 추가 함수
          // function addExhibition(exhibition) {
          //   exhibitions.push(exhibition);
          //   renderExhibitions();
          // }
          //
          // // 전시회 삭제 함수
          // function removeExhibition(index) {
          //   exhibitions.splice(index, 1);
          //   renderExhibitions();
          // }
        </script>
      </head>
      <body>
        <div layout:fragment="content">
          <div class="tab-menu">
            <button id="currentBtn">현재 전시</button>
            <button id="pastBtn">지난 전시</button>
            <button id="futureBtn">예정 전시</button>
            <button id="unknownBtn">미정</button>
          </div>

          <div class="search-bar">
            <input type="text" id="searchTitle" placeholder="전시 이름" />
            <input type="text" id="searchArtist" placeholder="작가" />
            <input type="text" id="searchMuseum" placeholder="미술관" />
            <button id="searchButton">검색</button>
          </div>

          <ul class="exhibition-list">
            <li class="exhibition-item">
              <img
                src="path_to_rembrandt_image.jpg"
                alt="렘브란트, 17세기의 사진가"
                class="exhibition-image"
              />
              <div class="exhibition-info">
                <h3>렘브란트, 17세기의 사진가</h3>
                <p>국립중앙박물관</p>
                <p>2023-07-05~2023-09-29</p>
              </div>
              <div class="exhibition-interested">
                <button class="exhibition-like">찜</button>
                <button class="exhibition-dislike">관심없음</button>
              </div>
            </li>
          </ul>
        </div>
      </body>
    </html>
  </html>
</html>
